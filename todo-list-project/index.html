<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—¥ç¨‹</title>
    <!-- å¼•å…¥ Vue.js æ¡†æ¶ -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- å¼•å…¥ Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- å¼•å…¥æ ·å¼ -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app">
        <h1>æˆ‘çš„æ—¥ç¨‹</h1>
        
        <!-- æ˜¾ç¤ºå½“å‰æ—¶é—´ -->
        <p>å½“å‰æ—¶é—´ï¼š{{ currentDateTime }}</p>

        <!-- æ·»åŠ æ–°æ—¥ç¨‹ -->
        <div>
            <input type="text" v-model="newTaskText" placeholder="è¾“å…¥æ–°æ—¥ç¨‹ï¼ˆä¾‹å¦‚ï¼š14:30 å¼€ä¼šï¼‰">
            <button @click="addTask">æ·»åŠ æ—¥ç¨‹</button>
        </div>

        <!-- å¯¼å…¥è¯¾è¡¨ -->
        <div style="margin: 10px 0;">
            <input type="file" id="import-schedule" accept=".xlsx">
            <button @click="importSchedule">å¯¼å…¥è¯¾è¡¨</button>
        </div>

        <!-- 1. æœªå®Œæˆçš„æ—¥ç¨‹åˆ—è¡¨ -->
        <div class="task-section">
            <h3>ğŸ“‹ å½“æ—¥æ—¥ç¨‹åˆ—è¡¨</h3>
            <div class="task-item" v-for="task in tasks" :key="task.id">
                <span class="task-time">{{ task.time }}</span>
                <span class="task-content" :class="{ current: task.isCurrent }">{{ task.content }}</span>
                <button @click="completeTask(task.id)" class="btn-complete">å®Œæˆ</button>
                <button @click="deleteTask(task.id)" class="btn-delete">åˆ é™¤</button>
            </div>
            <div class="empty-tip" v-if="tasks.length === 0">æš‚æ— æœªå®Œæˆçš„æ—¥ç¨‹</div>
        </div>

        <br>

        <!-- 2. å·²å®Œæˆçš„æ—¥ç¨‹åˆ—è¡¨ -->
        <div class="task-section completed-section">
            <h3>âœ… å½“æ—¥å·²å®Œæˆ</h3>
            <div class="task-item" v-for="task in completedTasks" :key="task.id">
                <span class="task-time">{{ task.time }}</span>
                <span class="task-content completed">{{ task.content }}</span>
                <button @click="deleteTask(task.id)" class="btn-delete">åˆ é™¤</button>
            </div>
            <div class="empty-tip" v-if="completedTasks.length === 0">æš‚æ— å·²å®Œæˆçš„æ—¥ç¨‹</div>
        </div>
    </div>

    <!-- Vue åº”ç”¨é€»è¾‘ -->
    <script>
    const { createApp } = Vue
    axios.defaults.baseURL = 'http://127.0.0.1:5000/api';

    createApp({
        data() {
            return {
                newTaskText: '',
                tasks: [],
                completedTasks: [],
                currentDateTime: ''
            }
        },
        methods: {
            // è·å–å½“æ—¥æœªå®Œæˆä»»åŠ¡
            fetchTasks() {
                const now = new Date();
                const weekdayMap = ['æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­', 'æ˜ŸæœŸæ—¥'];
                const todayWeekday = weekdayMap[now.getDay() === 0 ? 6 : now.getDay() - 1];

                axios.get(`/tasks?day=${todayWeekday}`)
                    .then(response => {
                        this.tasks = response.data;
                        this.updateCurrentTask(); // åŠ è½½ä»»åŠ¡åï¼Œç«‹å³æ ‡è®°å½“å‰ä»»åŠ¡
                    })
                    .catch(error => {
                        console.error('è·å–å½“æ—¥ä»»åŠ¡å¤±è´¥:', error);
                        alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿åç«¯å·²å¯åŠ¨ã€‚');
                    });
            },

            // è·å–å½“æ—¥å·²å®Œæˆä»»åŠ¡
            fetchCompletedTasks() {
                const now = new Date();
                const weekdayMap = ['æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­', 'æ˜ŸæœŸæ—¥'];
                const todayWeekday = weekdayMap[now.getDay() === 0 ? 6 : now.getDay() - 1];

                axios.get('/tasks')
                    .then(response => {
                        const allTasks = response.data;
                        this.completedTasks = allTasks.filter(
                            task => task.is_completed && task.time.includes(todayWeekday)
                        );
                        console.log('å·²å®Œæˆçš„ä»»åŠ¡ï¼š', this.completedTasks);
                    })
                    .catch(error => {
                        console.error('è·å–å·²å®Œæˆä»»åŠ¡å¤±è´¥ï¼š', error);
                    });
            },

            // æ·»åŠ æ–°ä»»åŠ¡
            addTask() {
                if (this.newTaskText.trim() === '') return;

                const [time, ...contentParts] = this.newTaskText.split(' ');
                const content = contentParts.join(' ');

                if (time && content) {
                    // æ–°å¢ä»»åŠ¡æ—¶ï¼Œè‡ªåŠ¨æ·»åŠ â€œå½“æ—¥æ˜ŸæœŸå‡ â€ï¼ˆç¡®ä¿èƒ½è¢«è¿‡æ»¤ï¼‰
                    const now = new Date();
                    const weekdayMap = ['æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­', 'æ˜ŸæœŸæ—¥'];
                    const todayWeekday = weekdayMap[now.getDay() === 0 ? 6 : now.getDay() - 1];
                    const taskTime = `${todayWeekday} ${time}`; // æ ¼å¼ï¼šâ€œæ˜ŸæœŸä¸‰ 14:30â€

                    axios.post('/tasks', { time: taskTime, content: content })
                        .then(response => {
                            this.fetchTasks();
                            this.newTaskText = '';
                        })
                        .catch(error => {
                            console.error('æ·»åŠ ä»»åŠ¡å¤±è´¥:', error);
                            alert('æ·»åŠ ä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                        });
                } else {
                    alert('è¯·è¾“å…¥æ­£ç¡®çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š"15:00 å–æ°´"');
                }
            },

            // æ ‡è®°ä»»åŠ¡å®Œæˆ
            completeTask(taskId) {
                axios.put(`/tasks/${taskId}/complete`)
                    .then(response => {
                        this.fetchTasks(); // åˆ·æ–°æœªå®Œæˆåˆ—è¡¨
                        this.completedTasks = response.data; // ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„å·²å®Œæˆåˆ—è¡¨
                    })
                    .catch(error => {
                        console.error('æ ‡è®°ä»»åŠ¡å®Œæˆå¤±è´¥:', error);
                        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                    });
            },

            // åˆ é™¤ä»»åŠ¡
            deleteTask(taskId) {
                const isConfirm = confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼');
                if (!isConfirm) return;

                axios.delete(`/tasks/${taskId}`)
                    .then(response => {
                        alert(response.data.message);
                        this.fetchTasks();
                        this.fetchCompletedTasks();
                    })
                    .catch(error => {
                        const errorMsg = error.response?.data?.error || 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•';
                        alert(`åˆ é™¤å¤±è´¥ï¼š${errorMsg}`);
                        console.error('åˆ é™¤ä»»åŠ¡å‡ºé”™ï¼š', error);
                    });
            },

            // æ›´æ–°å½“å‰æ—¶é—´
            updateCurrentTime() {
                const now = new Date();
                this.currentDateTime = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    weekday: 'long'
                });
            },

            // æ ‡è®°å½“å‰æ—¶é—´å¯¹åº”çš„ä»»åŠ¡ï¼ˆé«˜äº®ï¼‰
            updateCurrentTask() {
                const now = new Date();
                const currentHourMinute = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

                this.tasks.forEach(task => task.isCurrent = false);

                let currentTask = null;
                for (let task of this.tasks) {
                    const taskTimePart = task.time.split(' ')[1]; // æå–â€œæ—¶åˆ†â€éƒ¨åˆ†
                    if (taskTimePart && taskTimePart >= currentHourMinute) {
                        currentTask = task;
                        break;
                    }
                }

                if (currentTask) {
                    currentTask.isCurrent = true;
                }
            },

            // å¯¼å…¥è¯¾è¡¨
            importSchedule() {
                const fileInput = document.getElementById('import-schedule');
                const file = fileInput.files[0];
                if (!file) {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ª .xlsx æ ¼å¼çš„Excelæ–‡ä»¶');
                    return;
                }

                const formData = new FormData();
                formData.append('schedule_file', file);
                axios.post('/import_schedule', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                })
                .then(response => {
                    this.fetchTasks();
                    this.fetchCompletedTasks();
                    alert(response.data.message);
                })
                .catch(error => {
                    const errorMsg = error.response?.data?.error || 'å¯¼å…¥å¤±è´¥ï¼Œè¯·é‡è¯•';
                    alert(`å¯¼å…¥è¯¾è¡¨å¤±è´¥ï¼š${errorMsg}`);
                    console.error('å¯¼å…¥è¯¾è¡¨å¤±è´¥:', error);
                });
            }
        },
        mounted() {
            // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ•°æ®
            this.fetchTasks();
            this.fetchCompletedTasks();
            this.updateCurrentTime();

            // å®šæ—¶æ›´æ–°
            setInterval(() => {
                this.updateCurrentTime();
                // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡â€œå½“å‰ä»»åŠ¡â€
                if (new Date().getSeconds() === 0) {
                    this.updateCurrentTask();
                }
                // æ¯å¤©é›¶ç‚¹åˆ·æ–°æ‰€æœ‰æ•°æ®
                const now = new Date();
                if (now.getHours() === 0 && now.getMinutes() === 0 && now.getSeconds() === 0) {
                    this.fetchTasks();
                    this.fetchCompletedTasks();
                }
            }, 1000);
        }
    }).mount('#app')
    </script>
</body>
</html>