<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的日程</title>
    <!-- 引入 Vue.js 框架 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入 Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app">
        <h1>我的日程</h1>
        
        <!-- 显示当前时间 -->
        <p>当前时间：{{ currentDateTime }}</p>

        <!-- 添加新日程 -->
        <div>
            <input type="text" v-model="newTaskText" placeholder="输入新日程（例如：14:30 开会）">
            <button @click="addTask">添加日程</button>
        </div>

        <!-- 导入课表 -->
        <div style="margin: 10px 0;">
            <input type="file" id="import-schedule" accept=".xlsx">
            <button @click="importSchedule">导入课表</button>
        </div>

        <!-- 1. 未完成的日程列表 -->
        <div class="task-section">
            <h3>📋 当日日程列表</h3>
            <div class="task-item" v-for="task in tasks" :key="task.id">
                <span class="task-time">{{ task.time }}</span>
                <span class="task-content" :class="{ current: task.isCurrent }">{{ task.content }}</span>
                <button @click="completeTask(task.id)" class="btn-complete">完成</button>
                <button @click="deleteTask(task.id)" class="btn-delete">删除</button>
            </div>
            <div class="empty-tip" v-if="tasks.length === 0">暂无未完成的日程</div>
        </div>

        <br>

        <!-- 2. 已完成的日程列表 -->
        <div class="task-section completed-section">
            <h3>✅ 当日已完成</h3>
            <div class="task-item" v-for="task in completedTasks" :key="task.id">
                <span class="task-time">{{ task.time }}</span>
                <span class="task-content completed">{{ task.content }}</span>
                <button @click="deleteTask(task.id)" class="btn-delete">删除</button>
            </div>
            <div class="empty-tip" v-if="completedTasks.length === 0">暂无已完成的日程</div>
        </div>
    </div>

    <!-- Vue 应用逻辑 -->
    <script>
    const { createApp } = Vue
    axios.defaults.baseURL = 'http://127.0.0.1:5000/api';

    createApp({
        data() {
            return {
                newTaskText: '',
                tasks: [],
                completedTasks: [],
                currentDateTime: ''
            }
        },
        methods: {
            // 获取当日未完成任务
            fetchTasks() {
                const now = new Date();
                const weekdayMap = ['星期一', '星期二', '星期三', '星期四', '星期五', '星期六', '星期日'];
                const todayWeekday = weekdayMap[now.getDay() === 0 ? 6 : now.getDay() - 1];

                axios.get(`/tasks?day=${todayWeekday}`)
                    .then(response => {
                        this.tasks = response.data;
                        this.updateCurrentTask(); // 加载任务后，立即标记当前任务
                    })
                    .catch(error => {
                        console.error('获取当日任务失败:', error);
                        alert('无法连接到服务器，请确保后端已启动。');
                    });
            },

            // 获取当日已完成任务
            fetchCompletedTasks() {
                const now = new Date();
                const weekdayMap = ['星期一', '星期二', '星期三', '星期四', '星期五', '星期六', '星期日'];
                const todayWeekday = weekdayMap[now.getDay() === 0 ? 6 : now.getDay() - 1];

                axios.get('/tasks')
                    .then(response => {
                        const allTasks = response.data;
                        this.completedTasks = allTasks.filter(
                            task => task.is_completed && task.time.includes(todayWeekday)
                        );
                        console.log('已完成的任务：', this.completedTasks);
                    })
                    .catch(error => {
                        console.error('获取已完成任务失败：', error);
                    });
            },

            // 添加新任务
            addTask() {
                if (this.newTaskText.trim() === '') return;

                const [time, ...contentParts] = this.newTaskText.split(' ');
                const content = contentParts.join(' ');

                if (time && content) {
                    // 新增任务时，自动添加“当日星期几”（确保能被过滤）
                    const now = new Date();
                    const weekdayMap = ['星期一', '星期二', '星期三', '星期四', '星期五', '星期六', '星期日'];
                    const todayWeekday = weekdayMap[now.getDay() === 0 ? 6 : now.getDay() - 1];
                    const taskTime = `${todayWeekday} ${time}`; // 格式：“星期三 14:30”

                    axios.post('/tasks', { time: taskTime, content: content })
                        .then(response => {
                            this.fetchTasks();
                            this.newTaskText = '';
                        })
                        .catch(error => {
                            console.error('添加任务失败:', error);
                            alert('添加任务失败，请重试。');
                        });
                } else {
                    alert('请输入正确的格式，例如："15:00 喝水"');
                }
            },

            // 标记任务完成
            completeTask(taskId) {
                axios.put(`/tasks/${taskId}/complete`)
                    .then(response => {
                        this.fetchTasks(); // 刷新未完成列表
                        this.completedTasks = response.data; // 直接使用后端返回的已完成列表
                    })
                    .catch(error => {
                        console.error('标记任务完成失败:', error);
                        alert('操作失败，请重试。');
                    });
            },

            // 删除任务
            deleteTask(taskId) {
                const isConfirm = confirm('确定要删除这个任务吗？删除后无法恢复！');
                if (!isConfirm) return;

                axios.delete(`/tasks/${taskId}`)
                    .then(response => {
                        alert(response.data.message);
                        this.fetchTasks();
                        this.fetchCompletedTasks();
                    })
                    .catch(error => {
                        const errorMsg = error.response?.data?.error || '删除失败，请重试';
                        alert(`删除失败：${errorMsg}`);
                        console.error('删除任务出错：', error);
                    });
            },

            // 更新当前时间
            updateCurrentTime() {
                const now = new Date();
                this.currentDateTime = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    weekday: 'long'
                });
            },

            // 标记当前时间对应的任务（高亮）
            updateCurrentTask() {
                const now = new Date();
                const currentHourMinute = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

                this.tasks.forEach(task => task.isCurrent = false);

                let currentTask = null;
                for (let task of this.tasks) {
                    const taskTimePart = task.time.split(' ')[1]; // 提取“时分”部分
                    if (taskTimePart && taskTimePart >= currentHourMinute) {
                        currentTask = task;
                        break;
                    }
                }

                if (currentTask) {
                    currentTask.isCurrent = true;
                }
            },

            // 导入课表
            importSchedule() {
                const fileInput = document.getElementById('import-schedule');
                const file = fileInput.files[0];
                if (!file) {
                    alert('请选择一个 .xlsx 格式的Excel文件');
                    return;
                }

                const formData = new FormData();
                formData.append('schedule_file', file);
                axios.post('/import_schedule', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                })
                .then(response => {
                    this.fetchTasks();
                    this.fetchCompletedTasks();
                    alert(response.data.message);
                })
                .catch(error => {
                    const errorMsg = error.response?.data?.error || '导入失败，请重试';
                    alert(`导入课表失败：${errorMsg}`);
                    console.error('导入课表失败:', error);
                });
            }
        },
        mounted() {
            // 页面加载时初始化数据
            this.fetchTasks();
            this.fetchCompletedTasks();
            this.updateCurrentTime();

            // 定时更新
            setInterval(() => {
                this.updateCurrentTime();
                // 每分钟更新一次“当前任务”
                if (new Date().getSeconds() === 0) {
                    this.updateCurrentTask();
                }
                // 每天零点刷新所有数据
                const now = new Date();
                if (now.getHours() === 0 && now.getMinutes() === 0 && now.getSeconds() === 0) {
                    this.fetchTasks();
                    this.fetchCompletedTasks();
                }
            }, 1000);
        }
    }).mount('#app')
    </script>
</body>
</html>